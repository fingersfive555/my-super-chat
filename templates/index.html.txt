<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µèŠå¤©å®¤ V3 (Spy Mode)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        /* --- å…¨å±€é»‘å®¢é¢¨æ ¼è¨­å®š --- */
        body {
            background-color: #1a1a1a; /* æ·±ç°èƒŒæ™¯ */
            color: #00d2ff; /* éœ“è™¹è—æ–‡å­— */
            font-family: 'Courier New', monospace; /* ç·¨ç¢¼å­—é«” */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- ç™»å…¥æ¡†æ¨£å¼ --- */
        #login-screen {
            background: #2c3e50;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
            text-align: center;
        }

        input {
            background: #333;
            border: 1px solid #00d2ff;
            color: white;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            outline: none;
        }

        button {
            background: #00d2ff;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            transition: 0.3s;
        }

        button:hover {
            background: white;
            box-shadow: 0 0 15px #00d2ff;
        }

        /* --- èŠå¤©å®¤ä¸»ç•«é¢ --- */
        #chat-screen {
            display: none; /* ä¸€é–‹å§‹éš±è— */
            width: 90%;
            max-width: 600px;
            height: 80vh;
            background: #222;
            border: 2px solid #00d2ff;
            border-radius: 10px;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* æ¨™é¡Œåˆ— */
        .header {
            padding: 15px;
            background: #00d2ff;
            color: #1a1a1a;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- è¨Šæ¯é¡¯ç¤ºå€ --- */
        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-image: linear-gradient(#222 1px, transparent 1px),
            linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #1a1a1a;
        }

        /* è¨Šæ¯æ³¡æ³¡ */
        .msg {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease; /* å‹•ç•«æ•ˆæœ */
        }

        /* åˆ¥äººçš„è¨Šæ¯ */
        .msg-left {
            background: #2c3e50;
            color: white;
            align-self: flex-start;
            border-left: 3px solid #00d2ff;
        }

        /* æˆ‘çš„è¨Šæ¯ */
        .msg-right {
            background: #00d2ff;
            color: #1a1a1a;
            margin-left: auto; /* é å³å°é½Š */
            border-right: 3px solid white;
        }

        /* åå­—èˆ‡æ™‚é–“çš„å°å­— */
        .meta {
            font-size: 0.8em;
            display: block;
            margin-bottom: 5px;
            opacity: 0.8;
            font-weight: bold;
        }
        
        /* â˜…â˜…â˜… æ–°å¢ï¼šæ™‚é–“æ¨£å¼ â˜…â˜…â˜… */
        .time-text {
            font-size: 0.85em;
            font-weight: normal;
            margin-left: 5px;
            opacity: 0.7;
        }

        /* --- è«œå ±æ¨¡å¼ (Spy Mode) æ ¸å¿ƒç‰¹æ•ˆ --- */
        /* ç•¶çˆ¶å±¤æœ‰ spy-active é¡åˆ¥æ™‚ï¼Œè¨Šæ¯é è¨­æ¨¡ç³Š */
        .spy-active .msg {
            filter: blur(8px); /* æ¨¡ç³Šç¨‹åº¦ */
            opacity: 0.5;
            user-select: none; /* é˜²æ­¢è¢«é¸å–æ–‡å­— */
        }

        /* æ»‘é¼ ç§»ä¸Šå»æ™‚ï¼Œç¬é–“è®Šæ¸…æ™° */
        .spy-active .msg:hover {
            filter: blur(0);
            opacity: 1;
            user-select: auto;
            cursor: crosshair;
        }

        /* --- è¼¸å…¥å€ --- */
        .input-area {
            padding: 15px;
            background: #222;
            border-top: 1px solid #00d2ff;
            display: flex;
        }

        #msg-input {
            flex: 1;
        }

    </style>
</head>
<body>

    <div id="login-screen">
        <h2>ğŸ”’ å®‰å…¨é€£ç·šå…¥å£</h2>
        <input type="text" id="username" placeholder="ä»£è™Ÿ (Username)">
        <input type="text" id="room" placeholder="é »æ®µ (Room ID)">
        <br><br>
        <button onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="chat-screen">
        <div class="header">
            <span id="room-display">é »æ®µ: ???</span>
            
            <label style="font-size: 0.8em; cursor: pointer;">
                <input type="checkbox" id="spy-toggle"> ğŸ•µï¸ è«œå ±æ¨¡å¼
            </label>
        </div>

        <div id="messages">
            </div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥åŠ å¯†è¨Šæ¯...">
            <button onclick="sendMessage()">ç™¼é€</button>
        </div>
    </div>

    <script>
        var socket = io();
        var myName = "";
        var myRoom = "";

        // ç™»å…¥åŠŸèƒ½
        function login() {
            myName = $('#username').val();
            myRoom = $('#room').val();

            if(myName && myRoom) {
                // å‘Šè¨´ Python æˆ‘è¦åŠ å…¥é€™å€‹æˆ¿é–“
                socket.emit('join', {username: myName, room: myRoom});
                
                // åˆ‡æ›ç•«é¢
                $('#login-screen').hide();
                $('#chat-screen').css('display', 'flex'); // flex æ‰èƒ½ä¿æŒæ’ç‰ˆ
                $('#room-display').text("é »æ®µ: " + myRoom);
            } else {
                alert("è«‹è¼¸å…¥ä»£è™Ÿèˆ‡é »æ®µï¼");
            }
        }

        // ç›£è½è«œå ±æ¨¡å¼é–‹é—œ
        $('#spy-toggle').change(function() {
            if(this.checked) {
                $('#messages').addClass('spy-active'); // é–‹å•Ÿæ¨¡ç³Š
            } else {
                $('#messages').removeClass('spy-active'); // é—œé–‰æ¨¡ç³Š
            }
        });

        // æ¥æ”¶åˆ¥äººå‚³ä¾†çš„è¨Šæ¯
        socket.on('receive_message', function(data){
            var cls = (data.username === myName) ? 'msg-right' : 'msg-left';
            
            // â˜…â˜…â˜… é€™è£¡ä¿®æ”¹äº†ï¼šåŠ å…¥äº†æ™‚é–“é¡¯ç¤º â˜…â˜…â˜…
            var html = `
                <div class="msg ${cls}">
                    <span class="meta">
                        ${data.username} 
                        <small class="time-text">(${data.timestamp})</small>
                    </span>
                    ${data.message}
                </div>
            `;
            
            $('#messages').append(html);
            scrollToBottom();
        });

        // è¼‰å…¥æ­·å²è¨Šæ¯ (å¾è³‡æ–™åº«)
        socket.on('load_history', function(data){
            // æ¸…ç©ºç›®å‰çš„ç•«é¢ï¼Œé¿å…é‡è¤‡
            $('#messages').empty();

            data.forEach(function(msg){
                // msg[0]=åå­—, msg[1]=è¨Šæ¯, msg[2]=æ™‚é–“
                var cls = (msg[0] === myName) ? 'msg-right' : 'msg-left';
                
                // â˜…â˜…â˜… é€™è£¡ä¹Ÿä¿®æ”¹äº†ï¼šæ­·å²è¨Šæ¯ä¹Ÿè¦é¡¯ç¤ºæ™‚é–“ â˜…â˜…â˜…
                var html = `
                    <div class="msg ${cls}">
                        <span class="meta">
                            ${msg[0]} 
                            <small class="time-text">(${msg[2]})</small>
                        </span>
                        ${msg[1]}
                    </div>
                `;
                $('#messages').append(html);
            });
            scrollToBottom();
        });

        // ç™¼é€è¨Šæ¯
        function sendMessage() {
            var msg = $('#msg-input').val();
            if(msg) {
                socket.emit('send_message', {
                    username: myName, 
                    message: msg, 
                    room: myRoom
                });
                $('#msg-input').val(''); // æ¸…ç©ºè¼¸å…¥æ¡†
            }
        }

        // æŒ‰ Enter ä¹Ÿå¯ä»¥ç™¼é€
        $('#msg-input').keypress(function(e){
            if(e.which == 13) sendMessage();
        });

        // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        function scrollToBottom() {
            var div = document.getElementById('messages');
            div.scrollTop = div.scrollHeight;
        }

    </script>
</body>
</html>